<style>
    .luggage {
        /* width: 20%; */
        height: 20%;
    }
    .td-bg {
        background-position: center; 
        background-size: contain; 
        background-repeat: no-repeat;
        height: 200px;
    }
    .yearTable {
    position:relative;
    }
    .yearTable td {
        border:1px solid #CCCCCC;
        /* width:45px; */
        /* height:45px; */
        text-align:center;
        vertical-align:middle;
        position:relative;
    }
    .subscript {
        position: absolute;
        bottom: 0;
        right: 0;
        z-index: 10;
        text-align:right;
        vertical-align:bottom;
        font-size: 26px;
        color:whitesmoke;
    }
    .table-container {
        width: 90%;
        margin: 0 auto;
    }
    
</style>

<!DOCTYPE html>
<html lang="en">
<head>
<% include ../layouts/head %>
</head>
<header>
<% include ../layouts/sidenav %>
</header>
    <body class="" >
        <% include ../element/viewLuggageDetails %>
        <% 
            const count = resultData.passenger_capacity;
            const airplane_type = resultData.airplane_type; 
        %>
        <main>
            <div class="table-container" style="">
                <a href="/flight/view" id="back" class="waves-effect waves-light btn modal-trigger"><i class="material-icons left">arrow_back</i>GO BACK</a>

                <a href="#modal2" id="viewDetails" data-flightId="<%= resultData.flight_id %>" data-flight_number="<%= resultData.flight_number %>" class="waves-effect waves-light btn right modal-trigger"><i class="material-icons left">add_box</i>View Details</a>
                <table id="table" class="display centered highlight yearTable" width="100%">
                    <thead>
                        <tr class>
                            <% if (airplane_type === "Airbus 6S") { %>
                                <th width="16%">A</th>
                                <th width="16%">B</th>
                                <th width="16%">C</th>
                                <th width="16%">D</th>
                                <th width="16%">E</th>
                                <th width="16%">F</th>
                            <% } else if (airplane_type === "Airbus 9S") { %>
                                <th width="11%">A</th>
                                <th width="11%">B</th>
                                <th width="11%">C</th>
                                <th width="11%">D</th>
                                <th width="11%">E</th>
                                <th width="11%">F</th>
                                <th width="11%">G</th>
                                <th width="11%">H</th>
                                <th width="11%">I</th>
                            
                            <% } %>
                        </tr>
                    </thead>
                    <tbody class="table-body">
                        <%
                        
                        

                        <!-- NEW SHIT -->
                        if (airplane_type === "Airbus 6S") { 
                            const row = count/6; 
                            for (i=0; i < row; i++) { %>
                                <tr>
                                    <!-- <td background="/public/images/bag.png">seat-<%= i+1 %>A</td> -->
                                    
                                    <td id="seat-<%= i+1 %>A" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>A</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>B" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>B</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>C" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>C</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>D" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>D</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>E" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>E</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>F" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>F</span><span class="subscript">0</span></td>
                                </tr>
                        <%  }
                        } else if (airplane_type === "Airbus 9S") {
                            const row = count/9; 
                            for (i=0; i < row; i++) { %>
                                <tr>
                                    <!-- <td background="/public/images/bag.png">seat-<%= i+1 %>A</td> -->
                                    
                                    <td id="seat-<%= i+1 %>A" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>A</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>B" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>B</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>C" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>C</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>D" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>D</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>E" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>E</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>F" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>F</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>G" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>G</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>H" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>H</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>I" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>I</span><span class="subscript">0</span></td>
                                </tr>
                        <%  }
                        } else { 
                            <!-- OLD SHIT -->
                            const row = count/4;
                            if (count % 4 == 0) {
                                for (i=0; i < row; i++) { %>
                                    <tr>
                                        <!-- <td background="/public/images/bag.png">seat-<%= i+1 %>A</td> -->
                                        
                                        <td id="seat-<%= i+1 %>A" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>A</span><span class="subscript">0</span></td>
                                        <td id="seat-<%= i+1 %>B" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>B</span><span class="subscript">0</span></td>
                                        <td id="seat-<%= i+1 %>C" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>C</span><span class="subscript">0</span></td>
                                        <td id="seat-<%= i+1 %>D" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>D</span><span class="subscript">0</span></td>
                                    </tr>
                                <% }
                            } else if (count % 4 == 2) {
                                for (i=0; i < Math.floor(row); i++) { %>
                                    <tr>
                                        <td id="seat-<%= i+1 %>A" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>A</span><span class="subscript">0</span></td>
                                        <td id="seat-<%= i+1 %>B" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>B</span><span class="subscript">0</span></td>
                                        <td id="seat-<%= i+1 %>C" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>C</span><span class="subscript">0</span></td>
                                        <td id="seat-<%= i+1 %>D" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>D</span><span class="subscript">0</span></td>
                                    </tr>
                            <%  } %>
                                <tr>
                                    <td></td>
                                    <td id="seat-<%= i+1 %>B" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>B</span><span class="subscript">0</span></td>
                                    <td id="seat-<%= i+1 %>C" class="luggage td-bg" background="/public/images/bag.png"><span style="color:whitesmoke; font-size: 32px"><%= i+1 %>C</span><span class="subscript">0</span></td>
                                    <td></td>
                                </tr>
                        <%  } 
                        }   %>


                    </tbody>
                </table>
                <div class="legend">
                    <ul>
                        <div class="row">
                            <div class="col s3 center-align">
                                <li>
                                    <h3>
                                        Arrived
                                        <!-- <div style="width:90px; height:40px; background-color:#f44336; display:inline-block"></div> -->
                                        &nbsp;&nbsp;  <i class="Medium material-icons" style="color:rgb(96, 226, 96)">work</i>
                                    </h3> 
                                </li>
                            </div>
                            <div class="col s3 center-align">
                                <li>
                                    <h3>Picked Up
                                        <!-- <div style="width:60px; height:40px; background-color:#5498ff; display:inline-block"></div> -->
                                        &nbsp;&nbsp;<i class="Medium material-icons" style="color:#5498ff">work</i>
                                    </h3> 
                                </li>
                            </div>
                            <div class="col s3 center-align">
                                <li>
                                    <h3>Delayed
                                        <!-- <div style="width:60px; height:40px; background-color:#f44336; display:inline-block"></div> -->
                                        &nbsp;&nbsp;<i class="Medium material-icons" style="color:#f44336">work</i>
                                    </h3> 
                                </li>
                            </div>
                            <div class="col s3 center-align">
                                <li>
                                    <h3>
                                        Unoccupied
                                        <!-- <div style="width:90px; height:40px; background-color:#f44336; display:inline-block"></div> -->
                                        &nbsp;&nbsp;  <i class="Medium material-icons" style="color:rgba(94, 94, 95, 0.59)">work</i>
                                    </h3> 
                                </li>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>

        </main>
    




    <footer>
        <% include ../layouts/footer %>
    </footer>
    
    </body>
     
</html>
<script>
  // Initialize Firebase
  // TODO: Replace with your project's customized code snippet
  $(document).ready(() => {
    $('.sidenav').removeClass('sidenav-fixed');
    $('.sidenav').sidenav();
    $('.sidenav').sidenav('close');
 
    getLuggageStatus("<%- resultData.flight_id %>");
    getLuggageCount("<%- resultData.flight_id %>");
    var seconds = 60;
    window.setInterval(function(){
        if (seconds > 0)
            seconds--;
        // $("#circleBorder").html(seconds);
        // $("#currDateTime").html("As of " + moment().format('MMMM D YYYY, h:mm a'));
        if (seconds == 0) {
            getPickedUp("<%- resultData.flight_id %>");
            getLuggageStatus("<%- resultData.flight_id %>");
            getLuggageCount("<%- resultData.flight_id %>");
        }
        if (seconds <= 0)
            seconds = 60;
    }, 1000);
    
    dataTable = $('.luggageDetailsTable').DataTable({})
    $('.modal').modal();

    var config = {
        apiKey: "AIzaSyCyvVSCRq0_gLLXBQvdWFUfQGcQ4Sn9sJk",
        authDomain: "n-a-i-a.firebaseapp.com",
        databaseURL: "https://n-a-i-a.firebaseio.com",
        projectId: "n-a-i-a",
        storageBucket: "<BUCKET>.appspot.com",
        messagingSenderId: "478587123901",
    };
    firebase.initializeApp(config);
    var database = firebase.database();
    
    var rfidRef = firebase.database().ref('rfid:');
    
    rfidRef.once('value').then((snapshot)=> {
        console.log(snapshot.val().RFID_ID);
        console.log(snapshot.key);
    });
    
    rfidRef.on('child_changed', function(data) {
        console.log(data);
        const rfid = data.val();
        scanRfid(rfid);
    });

    $('#viewDetails').on('click', function() {
        const flight_id = $(this).data('flightid');
        const flight_num = $(this).data('flight_number');
        $('.luggageDetailsBody').html('');
        $.get("/luggage/details",{
            flight_id : flight_id
        }).done( (json) => {
            dataTable.destroy();
            dataTable = $('.luggageDetailsTable').DataTable({
                data: json.data,
                dom: 'Bfrtip',
                buttons: [
                    {
                        autoPrint: false,
                        extend: 'print',
                        title: '',
                        messageTop: 'Luggage Logs:',
                        customize: function (win) {
                            $(win.document.body)
                            .prepend('<center><h5>Luggage Report Summary for: <strong></br>'+ flight_num +'</strong></h5></center>'+
                                    'Date:' +  '</br> '+
                                    'Total Arrived:' + ' </br>' +
                                    'Total Delayed:' + ' </br>'   
                            );
                        }
                    }
                ],
                columns: [
                    { data: 'name'},
                    { data: 'arrival_time'},
                    { data: 'departure_time'},
                ]
            }) // ===== END OF DATATABLES
        })
    }); 
      
});

function scanRfid(rfid_uid) {
    $.get("/rfidScan",{
        rfid: rfid_uid
    }).then( (json) => {
        //expected result dito is yung seat number.
        //first arrival
        console.log(json);
        const seat_number = json.seat_number; 
        $('#seat-'+seat_number).css('background-color','rgb(96, 226, 96)');

    });
}

function getLuggageStatus(flight_id) {
    $.get('/getLuggageStatus',{
        flightId : flight_id
    }).then( (json) => {
        console.log(json);
        $('.luggage').css('background-color','rgba(94, 94, 95, 0.59)');
        json.resultData.forEach((el, i) => {
            if (el.status === 'arrived') {
                $('#seat-'+el.seat_number).css('background-color','rgb(96, 226, 96)');
            } else if (el.status === 'delayed') {
                $('#seat-'+el.seat_number).css('background-color','#f44336');
            } else if (el.status === 'pickedUp') {
                $('#seat-'+el.seat_number).css('background-color','#5498ff');
            }
        });
    });
}

function getLuggageCount(flight_id) {
    $.get('/getLuggageCount', {
        flightId : flight_id
    }).then( (json) => {
        console.log(json);
        json.resultData.forEach((el, i) => {
            var seatClass = $('#seat-'+el.seat_number);
            seatClass.data('totalLuggage', el.luggage_count);
            seatClass.children('span.subscript').html(el.luggage_count);
        });
    })
}

function getPickedUp(flight_id) {
    $.get('/luggage/getPickedUp', {
        flightId : flight_id
    })
    .then( json => {
        getLuggageStatus(flight_id);
    });
}
</script> 